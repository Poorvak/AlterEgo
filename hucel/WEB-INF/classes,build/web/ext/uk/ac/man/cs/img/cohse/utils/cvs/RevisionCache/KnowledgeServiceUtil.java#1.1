/*
 * KnowledgeServiceUtil.java
 * Created on November, 20, 2006
 * @author Yeliz Yesilada
 * This is a very simple wrapper class for the KnowledgeService 
 */
package uk.ac.man.cs.img.cohse.utils;

import java.util.Vector;
import java.util.Hashtable;

import java.net.URL;
import java.net.URLEncoder;
import java.net.URLDecoder;

import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.Document;
import org.w3c.dom.NodeList;

import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.DocumentBuilder;

import java.io.UnsupportedEncodingException;
import javax.xml.parsers.FactoryConfigurationError;
import javax.xml.parsers.ParserConfigurationException;
import org.xml.sax.SAXException;
import java.io.IOException;

/**
 * Used to manage Ontology Service
 * @author Yeliz Yesilada
 */
public class KnowledgeServiceUtil {
    
    private String knowledgeService = null;
    private String currentKnowledgeSource = null;
    private String[] currentTerms = null;
    
    private Hashtable cache;
    
    /** Creates a new instance of KnowledgeServiceUtil */
    public KnowledgeServiceUtil(String url, boolean cacheOn) {
        this.knowledgeService = url;
        if(cacheOn){
            cache = new Hashtable();
        }//if
    }
    
    /**
     *Returns a string array of all the terms in the given ontology
     *@param ontology Is the url of the ontology
     *@return A string array will be retunred that holds all the terms in the given ontology
     */
    public String[] getAllTerms(String knowledgeSource) {
        //was this knowledgeSource the subject of the previous query (can we reuse?)
        if(currentKnowledgeSource != null && currentKnowledgeSource.equals(knowledgeSource)) {
            return currentTerms;
        }
        
        currentKnowledgeSource = knowledgeSource;
        try {
            Vector terms = new Vector();
            knowledgeSource = URLEncoder.encode(knowledgeSource, "UTF-8");
            
            Document dom = getDOMResult("service=allterms&context=" + knowledgeSource);
            //System.out.println("I will try tp get the terms for the ontology: service=allterms&ontology="+ ontology);
            if(dom != null) {
                NodeList ts = dom.getElementsByTagName("cohse:term");
                for(int i=0; ts != null && i < ts.getLength(); i++) {
                    //Make sure that we got back a node before we try to get the value of that node
                    if(ts.item(i)!=null){
                        Element el = (Element) ts.item(i);
                        if(el!=null & el.getAttribute("cohse:term")!=null){
                            terms.add(el.getAttribute("cohse:term"));
                        }
                    }
                    //System.out.println("Terms :"+i);
                }//for
                currentTerms = new String[0];
                currentTerms = (String[]) terms.toArray(currentTerms);
                return currentTerms;
            }//if
            
            return null;
        } catch (UnsupportedEncodingException e) {
            System.err.println("UnsupportedEncodingException: Cannot encode the given URL ontology.");
            return null;
        } catch (FactoryConfigurationError  e) {
            System.err.println("FactoryConfigurationError: Could not create factory for parsing the document. ");
            return null;
        } catch (Exception e){
            System.err.println("KnowledgeServiceUtil Exception - getAllTemrs : an error occured: " + e);
            return null;
        }//catch
    }//getAllTerms
    
    /**
     *This will look for a concept corresponding to the given string.
     *@param term This is the term that will be search
     *@param ontology The term will be looked up in this ontology
     *@return  This returns an array of concepts
     */
    public String[] resolveTerm(String knowledgeSource, String term) {
        try {
            term = URLEncoder.encode(term, "UTF-8");
            knowledgeSource = URLEncoder.encode(knowledgeSource,"UTF-8");
            
            String[] concepts = null;
            System.out.println("KnowledgeServiceUtil - Resolve Term: "+"service=lookup&context=" + knowledgeSource + "&arg=" + term);
            Document dom = getDOMResult("service=lookup&context=" + knowledgeSource + "&arg=" + term);
            if(dom != null) {
                NodeList ts = dom.getElementsByTagName("cohse:concept");
                if(ts!=null && ts.getLength() >0) {
                    concepts = new String[ts.getLength()];
                    for(int i=0; i < ts.getLength(); i++) {
                        //Make sure that the first child is not null before, we try to get the node value
                        if(ts.item(i)!=null){
                            Element el = (Element) ts.item(i);
                            if(el!=null & el.getAttribute("cohse:concept")!=null){
                                concepts[i]=el.getAttribute("cohse:concept");
                            }//if
                        }//if
                    }//for
                }//if
            }//if
            System.out.println("Resolve Term - KnowledgeServiceUtil: "+concepts);
            return concepts;
        } catch (UnsupportedEncodingException e) {
            System.err.println("UnsupportedEncodingException: cannot encode the given term and the ontology URL");
            return null;
        } catch (Exception e){
            System.err.println("KnowledgeServiceUtil Exception - resolveTerm: an error occured: " + e);
            return null;
        }//catch
    }
    
    /**
     *This will return the label of a given concept with respect to the given ontology.
     *@param concept Concept that will be used to lookup for its label.
     *@param ontology This ontology will be used to lookup for its label.
     *@return String that will be the label of the concept.
     */
    public String getConceptRender(String knowledgeSource, String concept) {    
        try {            
            concept = URLEncoder.encode(concept, "UTF-8");
            
            Document dom = getDOMResult("service=render&context=" + knowledgeSource + "&arg=" + concept);
            String render = null;
            if(dom != null) {
                NodeList ts = dom.getElementsByTagName("cohse:term");
                if(ts!=null && ts.getLength() >0) {
                    //Make sure that we got back a node before we try to get the value of that node
                    if(ts.item(0)!=null){
                        Element el = (Element) ts.item(0);
                        if(el!=null & el.getAttribute("cohse:term")!=null){
                            render=el.getAttribute("cohse:term");
                        }//if
                    }//if
                }//if
            }//if
            return render;
        } catch(UnsupportedEncodingException e) {
            System.err.println("UnSupportedEncodingException: Cannot encode the given concept and the ontology URL!");
            return null;
        } catch (Exception e){
            System.err.println("KnowledgeServiceUtil Exception - getConcept Render: an error occured: " + e);
            return null;
        }//catch  
    }
    
    /**
     *This will return the documentation of a given concept with respect to the given ontology.
     *@param concept Concept that its description will be returned.
     *@param ontology Ontology that will be used to return the description of a given concept.
     *@return A string will be returned that holds the description of a given concept.
     */
    public String getDesc (String knowledgeSource, String concept){
        try {
            concept = URLEncoder.encode(concept, "UTF-8");
            
            Document dom = getDOMResult("service=documentation&arg=" + concept + "&context=" + knowledgeSource);
            String desc = "";
            if(dom != null) {
                NodeList ts = dom.getElementsByTagName("cohse:documentation");
                if(ts!=null && ts.getLength() >0) {
                    //Make sure that we got back a node before we try to get the value of that node
                    if(ts.item(0)!=null){
                        Element el = (Element) ts.item(0);
                        if(el!=null & el.getAttribute("cohse:content")!=null){
                            desc=el.getAttribute("cohse:content");
                        }//if
                    }//if
                }//if
            }//if
            if(desc.equals(""))
                return null;
            else
                return desc;
        } catch(UnsupportedEncodingException e) {
            System.err.println("UnSupportedEncodingException: Cannot encode the given concept and the ontology URL!");
            return null;
        } catch (Exception e){
            System.err.println("KnowledgeServiceUtil Exception - getDesc: an error occured: " + e);
            return null;
        }//catch
    }
    
    /**
     *This will return the supers of a given concept with respect to the given ontology.
     *@param concept The concept that will be used to retrieve its supers.
     *@param ontology The ontology that will be used to access the supers.
     *@return An array of strings that will hold the supers of the given cocnept.
     */
    public String[] getSuperConcepts(String knowledgeSource, String concept){
      try {
          concept = URLEncoder.encode(concept, "UTF-8");
          //ontology = URLEncoder.encode(ontology, "UTF-8");
          
          Document dom = getDOMResult("service=broader&context=" + knowledgeSource + "&arg=" + concept);
          String[] supers = null;
          if(dom != null) {
              NodeList ts = dom.getElementsByTagName("cohse:concept");
              if(ts != null && ts.getLength() > 0) {
                  supers = new String[ts.getLength()];
                  for(int i=0; ts != null && i < ts.getLength(); i++) {
                      //Make sure that we got back a node before we try to get the value of that node
                      if(ts.item(i)!=null){
                          Element el = (Element) ts.item(i);
                          if(el!=null & el.getAttribute("cohse:concept")!=null){
                              supers[i]=el.getAttribute("cohse:concept");
                          }//if
                      }//if
                      //System.out.println("Terms :"+i);
                  }//for
              }//if
          }//if
          return supers;          
      } catch(UnsupportedEncodingException e) {
          System.err.println("UnSupportedEncodingException: Cannot encode the given concept and the ontology URL!");
          return null;
      } catch (Exception e){
          System.err.println("KnowledgeServiceUtil Exception - getSuperConcepts: an error occured: " + e);
          return null;
      }//catch
    }
    
    /**
     *This will return the subs of a given concept with respect to the given ontology.
     *@param concept The concept that will be used to retrieve its subs.
     *@param ontology The ontology that will be used to access the subs.
     *@return An array of strings that will hold the supers of the given concept.
     */    
    public String[] getSubConcepts(String knowledgeSource, String concept){
        try {
            concept = URLEncoder.encode(concept, "UTF-8");
            //ontology = URLEncoder.encode(ontology, "UTF-8");
            
            Document dom = getDOMResult("service=narrower&context=" + knowledgeSource + "&arg=" + concept);
            String[] subs = null;
            if(dom != null) {
                NodeList ts = dom.getElementsByTagName("cohse:concept");
                if(ts != null && ts.getLength() > 0) {
                    subs = new String[ts.getLength()];
                    for(int i=0; ts != null && i < ts.getLength(); i++) {
                        //Make sure that we got back a node before we try to get the value of that node
                        if(ts.item(i)!=null){
                            Element el = (Element) ts.item(i);
                            if(el!=null & el.getAttribute("cohse:concept")!=null){
                                subs[i]=el.getAttribute("cohse:concept");
                            }//if
                        }//if
                        //System.out.println("Terms :"+i);
                    }//for
                }//if
            }//if
            return subs;
        } catch(UnsupportedEncodingException e) {
            System.err.println("UnSupportedEncodingException: Cannot encode the given concept and the ontology URL!");
            return null;
        } catch (Exception e){
            System.err.println("KnowledgeServiceUtil Exception - getSubConcepts: an error occured: " + e);
            return null;
        }//catch
    }//getSubTerms
    
    /**
     *This will return the subs of a given concept with respect to the given ontology.
     *@param concept The concept that will be used to retrieve its subs.
     *@param ontology The ontology that will be used to access the subs.
     *@return An array of strings that will hold the supers of the given concept.
     */    
    public String[] getRelatedConcepts(String knowledgeSource, String concept){
        try {
            concept = URLEncoder.encode(concept, "UTF-8");
            //ontology = URLEncoder.encode(ontology, "UTF-8");
            
            Document dom = getDOMResult("service=related&context=" + knowledgeSource + "&arg=" + concept);
            String[] subs = null;
            if(dom != null) {
                NodeList ts = dom.getElementsByTagName("cohse:concept");
                if(ts != null && ts.getLength() > 0) {
                    subs = new String[ts.getLength()];
                    for(int i=0; ts != null && i < ts.getLength(); i++) {
                        //Make sure that we got back a node before we try to get the value of that node
                        if(ts.item(i)!=null){
                            Element el = (Element) ts.item(i);
                            if(el!=null & el.getAttribute("cohse:concept")!=null){
                                subs[i]=el.getAttribute("cohse:concept");
                            }//if
                        }//if
                        //System.out.println("Terms :"+i);
                    }//for
                }//if
            }//if
            return subs;
        } catch(UnsupportedEncodingException e) {
            System.err.println("UnSupportedEncodingException: Cannot encode the given concept and the ontology URL!");
            return null;
        } catch (Exception e){
            System.err.println("KnowledgeServiceUtil Exception - getRelatedConcepts: an error occured: " + e);
            return null;
        }//catch
    }//getSubTerms
    
    /**
     *This will return all ontolgies that this service knows about.
     *@return This returns a string array which holds all the ontologies.
     */
    public String[] getAllKnowledgeSources() {
        try{
            Document dom = getDOMResult("service=contexts");
            String[] onts = null;
            if(dom != null) {
                NodeList ts = dom.getElementsByTagName("cohse:context");
                if(ts != null && ts.getLength() > 0) {
                    onts = new String[ts.getLength()];
                    for(int i=0; ts != null && i < ts.getLength(); i++) {                        
                        //Make sure that we got back a node before we try to get the value of that node
                        if(ts.item(i)!=null){
                            Element el = (Element) ts.item(i);
                            if(el!=null & el.getAttribute("cohse:uri")!=null){
                                onts[i]=el.getAttribute("cohse:uri");
                            }//if
                        }//if
                    }//for
                }//if
                //That means we can contact the ontology service but there is no ontology loaded to this service
                else{
                    onts = new String[0];
                }
            }//if
            return onts;
        } catch (Exception e){
            System.err.println("KnowledgeServiceUtil Exception - getAllOntologies: an error occured: " + e);
            return null;
        }//catch
    }
   
    /**
     * Returns keywords associated with an ontology. 
     * @param knowledgeSource This is the URL of the ontology
     * @return It will return a String array of keywords if they exist, otherwise returns null
     */
    public String[] getKeywords(String knowledgeSource) {
        
        Document doc = getDOMResult("service=keywords&context=" + knowledgeSource);
   
        //Processing the result XML file returned by Knowledge Service
        String keywords = null;
        if(doc != null) {
            NodeList ts = doc.getElementsByTagName("cohse:keywords");
            if(ts!=null && ts.getLength() >0) {
                //Make sure that we got back a node before we try to get the value of that node
                if(ts.item(0)!=null){
                    Element el = (Element) ts.item(0);
                    if(el!=null & el.getAttribute("cohse:keys")!=null){
                        keywords=el.getAttribute("cohse:keys");
                    }//if
                }//if
            }//if
        }//if
        
        //All keywords will be returned as a single string that includes a list of keywords separted by comma.
        if(keywords!=null){
            return keywords.split(",");
        }
        else{
            return null;
        }
    }
     
    /**
     *This will load the given ontology
     *@return This returns true in case of successfull loading of the ontology, and false in case of a failure.
     */
    public boolean loadOntology(String knowledgeServiceURI) {
        try{
            Document dom = getDOMResult("service=load&context="+knowledgeServiceURI);
            if(dom != null) {
                /**
                 *In case of a success, this will return an example file as follows:
                 *<cohse:result>
                 *<cohse:loaded..../>
                 */ 
                NodeList ts = dom.getElementsByTagName("cohse:loaded");
                if(ts != null && ts.getLength() > 0) {   
                    return true;
                }//if
                //That means we can contact the resource service but there is no knowledge resource loaded to this service
                else{
                    return false;
                }//else
            }//if
            //If there is something wrong with the returned document.
            else{                
                return false;
            }//else
        } catch (Exception e){
            System.err.println("KnowledgeserviceUtil Exception - loadOntology: an error occured: " + e);
            return false;
        }//catch
    }
    
    /**
     *This will be used to parse the returned XML document from the ontology service
     *@param arg Is the arguments that will be used with the ontology service url to retrieve the results
     *@return  It will return a Document object that can be processed.
     */
    private Document getDOMResult(String arg) {
        if(cache != null && cache.containsKey(arg)) {
            return (Document) cache.get(arg);
        }//if
        try {
            DocumentBuilderFactory docfac = DocumentBuilderFactory.newInstance();
            DocumentBuilder doc = docfac.newDocumentBuilder();
            Document result = doc.parse(knowledgeService + "?" + arg);
            if(cache != null) {
                cache.put(arg, result);
            }//if
            return result;
        } catch(FactoryConfigurationError e) {
            System.err.println("FactoryConfigurationError: Cannot instantiate the DocumentBuilderFactory");
            return null;
        }//catch
        catch(ParserConfigurationException e){
            System.err.println("ParserConfigurationException: Cannot create a new Document Builder");
            return null;
        }//catch
        catch(SAXException e){
            System.err.println("KnowledgeServiceUtil - getDOMReuslts - arg: "+arg);
            System.err.println("SAXException: Cannot parse the given argument");
            System.err.println("SAxExceptin: "+e.getMessage());
            return null;
        }//catch
        catch(IOException e){
            System.err.println("IOException: Cannot access the given arg and parse the document");
            return null;
        }//catch
    }
}//class KnowledgeServiceUtil
